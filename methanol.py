import streamlit as st
import numpy as np                          # –¥–ª—è –º–∞—Å—Å–∏–≤–æ–≤ –∏ –≥—Ä–∞—Ñ–∏–∫–æ–≤
import pandas as pd                         # –¥–ª—è —Ç–∞–±–ª–∏—Ü –∏ —ç–∫—Å–ø–æ—Ä—Ç–∞
import matplotlib.pyplot as plt             # –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–æ–≤
from CoolProp.CoolProp import HAPropsSI     # —Ä–∞—Å—á–µ—Ç —Ç–æ—á–∫–∏ —Ä–æ—Å—ã –∏ –≤–ª–∞–∂–Ω–æ—Å—Ç–∏
import math
from io import BytesIO                      # –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ–∞–π–ª–∞ –≤ –ø–∞–º—è—Ç–∏
import xlsxwriter                           # —ç–∫—Å–ø–æ—Ä—Ç Excel

def run_methanol_calc():
    # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —à–∏—Ä–∏–Ω—ã —Å—Ç—Ä–∞–Ω–∏—Ü—ã –Ω–∞ –≤—Å—é —à–∏—Ä–∏–Ω—É —ç–∫—Ä–∞–Ω–∞
    st.set_page_config(layout="wide")

    # --- –í–≤–æ–¥ –∫–ª—é—á–∞ OpenWeatherMap ---
    st.sidebar.subheader("–ü–æ–≥–æ–¥–∞")
    weather_api_key = st.sidebar.text_input("–í–≤–µ–¥–∏—Ç–µ API –∫–ª—é—á OpenWeatherMap",
                                            type="password")  # type="password" –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ —Ç–µ–∫—Å—Ç –±—É–¥–µ—Ç —Å–∫—Ä—ã—Ç (–∫–∞–∫ –ø–∞—Ä–æ–ª—å).
    location = st.sidebar.text_input("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –Ω–∞—Å–µ–ª—ë–Ω–Ω–æ–≥–æ –ø—É–Ω–∫—Ç–∞",
                                     value="–ú—É—Ä–∞–≤–ª–µ–Ω–∫–æ")  # –í–≤–æ–¥ –≥–æ—Ä–æ–¥–∞ –∏–ª–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç, –ø–æ—É–º–æ–ª—á–∞–Ω–∏—é –ú—É—Ä–∞–≤–ª–µ–Ω–∫–æ

    ground_temp = None
    if weather_api_key and location:  # –ü—Ä–æ–≤–µ—Ä–∫–∞: –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤—ë–ª –∏ API-–∫–ª—é—á, –∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞, —Ç–æ–≥–¥–∞ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ.
        try:
            weather_url = f"https://api.openweathermap.org/data/2.5/weather?q={location}&appid={weather_api_key}&units=metric"  # –§–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è URL –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ –∫ OpenWeatherMap API
            response = requests.get(weather_url)  # –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è HTTP GET-–∑–∞–ø—Ä–æ—Å –ø–æ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–Ω–æ–º—É –∞–¥—Ä–µ—Å—É
            weather_data = response.json()  # –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞ (–≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON) –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç—Å—è –≤ —Å–ª–æ–≤–∞—Ä—å Python
            if "main" in weather_data:  # –ü—Ä–æ–≤–µ—Ä–∫–∞, –µ—Å—Ç—å –ª–∏ –≤ –æ—Ç–≤–µ—Ç–µ —Å–µ–∫—Ü–∏—è "main" (–≥–¥–µ —Ö—Ä–∞–Ω—è—Ç—Å—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ)
                ground_temp = weather_data["main"][
                                  "temp"] - 3  # –ë–µ—Ä—ë—Ç—Å—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –≤–æ–∑–¥—É—Ö–∞ (weather_data["main"]["temp"]) –∏ –æ—Ç –Ω–µ—ë –≤—ã—á–∏—Ç–∞–µ—Ç—Å—è 3¬∞C, —á—Ç–æ–±—ã –ø—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω–æ –æ—Ü–µ–Ω–∏—Ç—å —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—É –≥—Ä—É–Ω—Ç–∞ (—Ç–∞–∫ –∫–∞–∫ –æ–Ω–∞ –æ–±—ã—á–Ω–æ –Ω–µ–º–Ω–æ–≥–æ –Ω–∏–∂–µ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã –≤–æ–∑–¥—É—Ö–∞).
                st.sidebar.success(
                    f"–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –≥—Ä—É–Ω—Ç–∞: {ground_temp:.1f} ¬∞C")  # –ï—Å–ª–∏ –≤—Å—ë –ø—Ä–æ—à–ª–æ —É—Å–ø–µ—à–Ω–æ, –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ —Å–∞–π–¥–±–∞—Ä–µ ‚Äî —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –≥—Ä—É–Ω—Ç–∞, –æ–∫—Ä—É–≥–ª—ë–Ω–Ω–∞—è –¥–æ –æ–¥–Ω–æ–≥–æ –∑–Ω–∞–∫–∞ –ø–æ—Å–ª–µ –∑–∞–ø—è—Ç–æ–π.
        except Exception as e:
            st.sidebar.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö –æ –ø–æ–≥–æ–¥–µ")

            # --- –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö Excel ---
    uploaded_file = st.sidebar.file_uploader("–ó–∞–≥—Ä—É–∑–∏—Ç–µ Excel —Ñ–∞–π–ª —Å –¥–∞–Ω–Ω—ã–º–∏",
                                             type="xlsx")  # –†–∞–∑–º–µ—â–∞–µ–º –≤ –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏ slidebar
    if uploaded_file:  # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–≥—Ä—É–∂–µ–Ω –ª–∏ —Ñ–∞–π–ª. –ï—Å–ª–∏ —Ñ–∞–π–ª –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω (—Ç–æ –µ—Å—Ç—å uploaded_file –Ω–µ None), —Ç–æ–≥–¥–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Å–ª–µ–¥—É—é—â–∏–π –±–ª–æ–∫ –∫–æ–¥–∞.
        excel_data = pd.ExcelFile(
            uploaded_file)  # –ó–∞–≥—Ä—É–∂–∞–µ—Ç Excel-—Ñ–∞–π–ª –≤ –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω—É—é –ø–∞–º—è—Ç—å –∏ –ø–æ–∑–≤–æ–ª—è–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —Å –Ω–∏–º –±–µ–∑ –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ —Å—á–∏—Ç—ã–≤–∞–Ω–∏—è –≤—Å–µ—Ö –ª–∏—Å—Ç–æ–≤.

        df = excel_data.parse(
            'dhtmlxGrid')  # –ó–∞–≥—Ä—É–∂–∞–µ—Ç –≤ –ø–∞–º—è—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –ª–∏—Å—Ç Excel-—Ñ–∞–π–ª–∞ —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º dhtmlxGrid, —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π df, –∫–æ—Ç–æ—Ä–∞—è —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è —Ç–∞–±–ª–∏—Ü–µ–π –¥–∞–Ω–Ω—ã—Ö

        if '–î–∞—Ç–∞ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞' in df.columns:  # –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –µ—Å—Ç—å –ª–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ —Å—Ç–æ–ª–±–µ—Ü —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º –î–∞—Ç–∞ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞
            df['–î–∞—Ç–∞ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞'] = pd.to_datetime(df['–î–∞—Ç–∞ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞'],
                                                  errors='coerce')  # –ü—Ä–∏–≤–æ–¥–∏—Ç –∑–Ω–∞—á–µ–Ω–∏—è —ç—Ç–æ–≥–æ —Å—Ç–æ–ª–±—Ü–∞ –∫ —Ñ–æ—Ä–º–∞—Ç—É –¥–∞—Ç—ã –∏ –≤—Ä–µ–º–µ–Ω–∏, —Ç.–µ. –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç —Å—Ç—Ä–æ–∫–∏ –∏–ª–∏ —á–∏—Å–ª–∞ –≤ –¥–∞—Ç—ã

        # --- –í—ã–±–æ—Ä –ú–µ—Å—Ç–æ—Ä–æ–∂–¥–µ–Ω–∏—è, –î–ù–° –∏ —Å—Ç—É–ø–µ–Ω–∏ ---
        st.sidebar.subheader("–í—ã–±–æ—Ä –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤")
        field = st.sidebar.selectbox("–í—ã–±–µ—Ä–∏—Ç–µ –º–µ—Å—Ç–æ—Ä–æ–∂–¥–µ–Ω–∏–µ", df[
            '–ú–µ—Å—Ç–æ—Ä–æ–∂–¥–µ–Ω–∏–µ'].unique())  # –°–æ–∑–¥–∞—ë—Ç –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ –≤ —Å–∞–π–¥–±–∞—Ä–µ —Å –Ω–∞–¥–ø–∏—Å—å—é: "–í—ã–±–µ—Ä–∏—Ç–µ –º–µ—Å—Ç–æ—Ä–æ–∂–¥–µ–Ω–∏–µ". df['–ú–µ—Å—Ç–æ—Ä–æ–∂–¥–µ–Ω–∏–µ'].unique() ‚Äî –∏–∑–≤–ª–µ–∫–∞–µ—Ç —Å–ø–∏—Å–æ–∫ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –º–µ—Å—Ç–æ—Ä–æ–∂–¥–µ–Ω–∏–π –∏–∑ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ DataFrame df
        df_field = df[df[
                          '–ú–µ—Å—Ç–æ—Ä–æ–∂–¥–µ–Ω–∏–µ'] == field]  # –û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤—ã–≤–∞–µ—Ç DataFrame, –æ—Å—Ç–∞–≤–ª—è—è —Ç–æ–ª—å–∫–æ —Å—Ç—Ä–æ–∫–∏, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É –º–µ—Å—Ç–æ—Ä–æ–∂–¥–µ–Ω–∏—é

        dns = st.sidebar.selectbox("–í—ã–±–µ—Ä–∏—Ç–µ –æ–±—ä–µ–∫—Ç –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ (–î–ù–°)", df_field[
            '–î–ù–°'].unique())  # –°–æ–∑–¥–∞—ë—Ç –≤—Ç–æ—Ä–æ–π –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫. –ò–∑–≤–ª–µ–∫–∞–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –î–ù–°, —Ç–æ–ª—å–∫–æ —Å—Ä–µ–¥–∏ —Å—Ç—Ä–æ–∫ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –º–µ—Å—Ç–æ—Ä–æ–∂–¥–µ–Ω–∏—è (df_field)
        df_dns = df_field[df_field[
                              '–î–ù–°'] == dns]  # –ï—â—ë –æ–¥–Ω–æ —Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–∏–µ: –æ—Å—Ç–∞–≤–ª—è–µ—Ç —Ç–æ–ª—å–∫–æ —Ç–µ —Å—Ç—Ä–æ–∫–∏, –≥–¥–µ –æ–±—ä–µ–∫—Ç –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É (dns)

        stage = st.sidebar.selectbox("–£–∫–∞–∂–∏—Ç–µ —Å—Ç—É–ø–µ–Ω—å –æ—Ç–±–æ—Ä–∞",
                                     df_dns['–°—Ç—É–ø–µ–Ω—å –æ—Ç–±–æ—Ä–∞'].unique())  # –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ –≤—ã–±–æ—Ä—É –æ–±—ä–µ–∫—Ç–∞ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏
        selected_df = df_dns[df_dns['–°—Ç—É–ø–µ–Ω—å –æ—Ç–±–æ—Ä–∞'] == stage]

        selected_row = selected_df.iloc[
            -1]  # –ë–µ—Ä—ë—Ç—Å—è –ø–æ—Å–ª–µ–¥–Ω—è—è —Å—Ç—Ä–æ–∫–∞ –∏–∑ selected_df ‚Äî –ø—Ä–µ–¥–ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ, —Å–∞–º–∞—è –ø–æ—Å–ª–µ–¥–Ω—è—è (–∞–∫—Ç—É–∞–ª—å–Ω–∞—è) –∑–∞–ø–∏—Å—å. –ü–æ—Ç–æ–º—É —á—Ç–æ, –∫–∞–∫ –ø—Ä–∞–≤–∏–ª–æ, –¥–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ —Ö—Ä–æ–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–º –ø–æ—Ä—è–¥–∫–µ.

        st.markdown(f"""                       
        ### –ú–µ—Å—Ç–æ—Ä–æ–∂–¥–µ–Ω–∏–µ: {field}                
        ### –û–±—ä–µ–∫—Ç –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏: {dns}
        ### –°—Ç—É–ø–µ–Ω—å –æ—Ç–±–æ—Ä–∞: {stage}
        """)  # –¢–µ–∫—Å—Ç–æ–≤—ã–π –≤—ã–≤–æ–¥ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤, –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º.

        # --- –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –≥–∞–∑–∞ ---
        gas_density = selected_row['–ü–ª–æ—Ç–Ω–æ—Å—Ç—å —Ä–µ–∞–ª—å–Ω–æ–≥–æ –≥–∞–∑–∞']  # –ë–µ—Ä–µ—Ç—Å—è –∑–Ω–∞—á–µ–Ω–∏–µ —Å —Ç–∞–±–ª–∏—Ü—ã
        gas_flow = st.sidebar.number_input("–†–∞—Å—Ö–æ–¥ –≥–∞–∑–∞ (–º¬≥/—Å—É—Ç)", min_value=1.0,
                                           value=100000.0)  # –†–∞—Å—Ö–æ–¥ –∑–∞–¥–∞–µ—Ç—Å—è –≤ —Ä—É—á–Ω—É—é

        composition = {k: selected_row[k] if k in selected_row else 0.0 for k in [
            "–ú–µ—Ç–∞–Ω", "–≠—Ç–∞–Ω", "–ü—Ä–æ–ø–∞–Ω", "–∏-–ë—É—Ç–∞–Ω", "–Ω-–ë—É—Ç–∞–Ω", "–∏-–ü–µ–Ω—Ç–∞–Ω", "–Ω-–ü–µ–Ω—Ç–∞–Ω",
            "–ì–µ–∫—Å–∞–Ω—ã", "–ì–µ–ø—Ç–∞–Ω—ã", "–û–∫—Ç–∞–Ω—ã", "–ö–∏—Å–ª–æ—Ä–æ–¥", "–í–æ–¥–æ—Ä–æ–¥", "–ì–µ–ª–∏–π", "–ê–∑–æ—Ç"
        ]}  # –°–æ–∑–¥–∞—ë—Ç—Å—è —Å–ª–æ–≤–∞—Ä—å composition, –≥–¥–µ:–ö–ª—é—á (k) ‚Äî —ç—Ç–æ –∏–º—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ –≥–∞–∑–∞, –ó–Ω–∞—á–µ–Ω–∏–µ (v) ‚Äî —ç—Ç–æ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–≥–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ –≤ –¥–∞–Ω–Ω—ã—Ö (selected_row[k]). –ï—Å–ª–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ –Ω–µ—Ç –≤ —Å—Ç—Ä–æ–∫–µ —Ç–æ –ø—Ä–∏—Å–≤–∞–∏–≤–∞–µ—Ç—Å—è –∑–Ω–∞—á–µ–Ω–∏–µ 0,0

        total_mol = sum(composition.values())
        if total_mol == 0:
            st.error("–°—É–º–º–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –≥–∞–∑–∞ —Ä–∞–≤–Ω–∞ –Ω—É–ª—é. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–∞–Ω–Ω—ã–µ!")
            st.stop()  # –ï—Å–ª–∏ –≤—ã—Ö–æ–¥–∏—Ç –æ—à–∏–±–∫–∞, —Ç–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è
        composition = {k: v / total_mol for k, v in
                       composition.items()}  # –í—Å–µ –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ —Å–ª–æ–≤–∞—Ä—è composition –¥–µ–ª—è—Ç—Å—è –Ω–∞ total_mol, —á—Ç–æ–±—ã –ø—Ä–∏–≤–µ—Å—Ç–∏ –∏—Ö –∫ –¥–æ–ª—è–º –æ—Ç 1.0

        # –î–∞–≤–ª–µ–Ω–∏–µ –∏ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –≥–∞–∑–∞
        pressure = st.sidebar.slider("–î–∞–≤–ª–µ–Ω–∏–µ (–ú–ü–∞)", 1.0, 10.0, 6.0)  # –°–æ–∑–¥–∞–µ–º –ø–æ–ª–∑—É–Ω–æ–∫ –¥–ª—è –≤—ã–±–æ—Ä–∞ –¥–∞–≤–ª–µ–Ω–∏—è
        gas_temp = st.sidebar.slider("–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –≥–∞–∑–∞ (¬∞C)", 0.0, 60.0, 5.0)  # –°–æ–∑–¥–∞–µ–º –ø–æ–ª–∑—É–Ω–æ–∫ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã
        effective_temp = min(gas_temp,
                             ground_temp if ground_temp is not None else gas_temp)  # –í—ã–±–∏—Ä–∞–µ—Ç—Å—è –Ω–∞–∏–º–µ–Ω—å—à–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –º–µ–∂–¥—É —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–æ–π –≥–∞–∑–∞ –∏ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–æ–π –≥—Ä—É–Ω—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—É, –ø–æ—Å–∫–æ–ª—å–∫—É –∏–º–µ–Ω–Ω–æ –ø—Ä–∏ –Ω–µ–π –≤–æ–∑–º–æ–∂–Ω–∞ –∫–æ–Ω–¥–µ–Ω—Å–∞—Ü–∏—è –≤–æ–¥—ã
        T_K = effective_temp + 273.15  # –ü–µ—Ä–µ–≤–æ–¥–∏—Ç —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—É –∏–∑ –≥—Ä–∞–¥—É—Å–æ–≤ –¶–µ–ª—å—Å–∏—è –≤ –ö–µ–ª—å–≤–∏–Ω—ã
        P_Pa = pressure * 1e6  # –ü–µ—Ä–µ–≤–æ–¥–∏—Ç –¥–∞–≤–ª–µ–Ω–∏–µ –∏–∑ –º–µ–≥–∞–ø–∞—Å–∫–∞–ª–µ–π (–ú–ü–∞) –≤ –ø–∞—Å–∫–∞–ª–∏ (–ü–∞), –ø–æ—Ç–æ–º—É —á—Ç–æ –≤ –∏–Ω–∂–µ–Ω–µ—Ä–Ω—ã—Ö –±–∏–±–ª–∏–æ—Ç–µ–∫–∞—Ö (–∫–∞–∫ CoolProp) –¥–∞–≤–ª–µ–Ω–∏–µ —á–∞—Å—Ç–æ —É–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –≤ –ø–∞—Å–∫–∞–ª—è—Ö

        # –í–ª–∞–∂–Ω–æ—Å—Ç—å
        st.sidebar.subheader("–í–ª–∞–∂–Ω–æ—Å—Ç—å –≥–∞–∑–∞")
        dew_mode = st.sidebar.radio("–ò—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö –æ –≤–æ–¥–µ", ["–ò–∑–º–µ—Ä–µ–Ω–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ (–≥/–º¬≥)",
                                                               "–ü–æ —Ç–æ—á–∫–µ —Ä–æ—Å—ã (¬∞C)"])  # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç—Å—è –≤—ã–±—Ä–∞—Ç—å, –æ—Ç–∫—É–¥–∞ –±—É–¥–µ—Ç –≤–≤–æ–¥–∏—Ç—å—Å—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤–ª–∞–∂–Ω–æ—Å—Ç–∏
        if dew_mode == "–ò–∑–º–µ—Ä–µ–Ω–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ (–≥/–º¬≥)":
            measured_water_content = st.sidebar.number_input("–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –≤–æ–¥—ã (–≥/–º¬≥)", min_value=0.0, value=20.0)
        else:
            dew_point = st.sidebar.number_input("–¢–æ—á–∫–∞ —Ä–æ—Å—ã (¬∞C)",
                                                value=0.0)  # –†–∞—Å—á–µ—Ç –ø–æ —Ç–æ—á–∫–µ —Ä–æ—Å—ã, —Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç –µ—ë –∑–Ω–∞—á–µ–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 0‚ÄØ¬∞C)
            try:
                RH = 1.0  # –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Ä–∞—Å—á–µ—Ç –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏–∏ –≤–æ–¥—ã —Å –ø–æ–º–æ—â—å—é –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ CoolProp,
                w_kg_kgdryair = HAPropsSI("W", "T", dew_point + 273.15, "P", P_Pa, "R",
                                          RH)  # HAPropsSI(...) ‚Äî —Ñ—É–Ω–∫—Ü–∏—è —Ä–∞—Å—á–µ—Ç–∞ –≤–ª–∞–∂–Ω–æ—Å—Ç–∏ –≤–æ–∑–¥—É—Ö–∞ –ø–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º
                measured_water_content = w_kg_kgdryair * 1000 * 18.015
            except:
                measured_water_content = 0.0
                st.warning("–û—à–∏–±–∫–∞ —Ä–∞—Å—á–µ—Ç–∞ –ø–æ —Ç–æ—á–∫–µ —Ä–æ—Å—ã")

        try:
            max_w_kg_kgdryair = HAPropsSI("W", "T", T_K, "P", P_Pa, "R",
                                          1.0)  # –í—ã—á–∏—Å–ª—è–µ—Ç—Å—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –≤–ª–∞–≥–æ—Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –ø—Ä–∏ —Ç–µ–∫—É—â–µ–π —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–µ –∏ –¥–∞–≤–ª–µ–Ω–∏–∏ (100% –≤–ª–∞–∂–Ω–æ—Å—Ç—å), –ø—Ä–µ–¥–µ–ª—å–Ω–æ –¥–æ–ø—É—Å—Ç–∏–º–∞—è –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—è –≤–æ–¥—è–Ω–æ–≥–æ –ø–∞—Ä–∞ –≤ –≥–∞–∑–µ, –≤—ã—à–µ –∫–æ—Ç–æ—Ä–æ–π –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –∫–æ–Ω–¥–µ–Ω—Å–∞—Ü–∏—è (–∫–æ–Ω–¥–µ–Ω—Å–∞—Ç –≤ —Ç—Ä—É–±–æ–ø—Ä–æ–≤–æ–¥–µ).
            max_water_g_m3 = max_w_kg_kgdryair * 1000 * 18.015
        except:
            max_water_g_m3 = None

        result = {
            "–î–∞–≤–ª–µ–Ω–∏–µ (–ú–ü–∞)": pressure,
            "–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ (¬∞C)": effective_temp,
            "–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –≤–æ–¥—ã (–≥/–º¬≥)": measured_water_content,
            "–ú–∞–∫—Å. –¥–æ–ø—É—Å—Ç–∏–º–æ–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –≤–æ–¥—ã (–≥/–º¬≥)": max_water_g_m3
        }  # –°–æ—Ö—Ä–∞–Ω—è–µ–º –±–∞–∑–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ —Å–ª–æ–≤–∞—Ä—å result, –∫–æ—Ç–æ—Ä—ã–π –ø–æ—Ç–æ–º –æ—Ç–æ–±—Ä–∞–∑–∏–º –≤ —Ç–∞–±–ª–∏—Ü–µ

        if max_water_g_m3 is not None:  # –ï—Å–ª–∏ —Ä–∞—Å—á–µ—Ç –¥–æ–ø—É—Å—Ç–∏–º–æ–π –≤–ª–∞–≥–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω (max_water_g_m3 –Ω–µ None) –∏ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –≤–æ–¥—ã –ø—Ä–µ–≤—ã—à–∞–µ—Ç –¥–æ–ø—É—Å—Ç–∏–º–æ–µ, –Ω–∞—á–∏–Ω–∞–µ–º —Ä–∞—Å—á–µ—Ç
            if measured_water_content > max_water_g_m3:
                excess_water = measured_water_content - max_water_g_m3  # –†–∞–∑–Ω–∏—Ü–∞ –º–µ–∂–¥—É —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–º –∏ –¥–æ–ø—É—Å—Ç–∏–º—ã–º —É—Ä–æ–≤–Ω–µ–º
                excess_water_kg = (
                                              excess_water / 1000) * gas_flow * gas_density  # –ü–µ—Ä–µ–≤–æ–¥ –∏–∑–±—ã—Ç–∫–∞ –≤–ª–∞–≥–∏ –≤ –º–∞—Å—Å—É –≤ –∫–∏–ª–æ–≥—Ä–∞–º–º–∞—Ö: excess_water / 1000 ‚Äî –≤ –∫–≥/–º¬≥, gas_flow ‚Äî –æ–±—ä–µ–º –≥–∞–∑–∞ –≤ –º¬≥/—Å—É—Ç, gas_density ‚Äî –º–∞—Å—Å–∞ 1 –º¬≥ –≥–∞–∑–∞
                methanol_mass_kg = excess_water_kg * 1.1  # –ù–∞ –ø–æ–¥–∞—á—É –º–µ—Ç–∞–Ω–æ–ª–∞ –±–µ—Ä–µ—Ç—Å—è 110% –æ—Ç –º–∞—Å—Å—ã –≤–æ–¥—ã ‚Äî —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –∑–∞–ø–∞—Å 10%
                methanol_density = 792.0  # –ü–ª–æ—Ç–Ω–æ—Å—Ç—å –º–µ—Ç–∞–Ω–æ–ª–∞ –∫–≥/–º3
                methanol_vol_liters = methanol_mass_kg / (methanol_density / 1000)  # –ü–µ—Ä–µ–≤–æ–¥ –º–∞—Å—Å—ã –º–µ—Ç–∞–Ω–æ–ª–∞ –≤ –ª–∏—Ç—Ä—ã.
                optimal_methanol = methanol_vol_liters * 0.85  # –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ä–∞—Å—Ö–æ–¥–∞ –º–µ—Ç–∞–Ω–æ–ª–∞. –ú–æ–∂–Ω–æ —É–º–µ–Ω—å—à–∏—Ç—å –ø–æ–¥–∞—á—É –Ω–∞ 15%, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –ø–µ—Ä–µ—Ä–∞—Å—Ö–æ–¥–∞.
                economy = methanol_vol_liters - optimal_methanol  # –°–∫–æ–ª—å–∫–æ –ª–∏—Ç—Ä–æ–≤ –º–æ–∂–Ω–æ —Å—ç–∫–æ–Ω–æ–º–∏—Ç—å.

                result[
                    "–ò–∑–±—ã—Ç–æ–∫ –≤–ª–∞–≥–∏ (–≥/–º¬≥)"] = excess_water  # –í—Å–µ —Ä–∞—Å—á–µ—Ç—ã –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –≤ —Å–ª–æ–≤–∞—Ä—å result, –∑–∞—Ç–µ–º –æ–Ω –≤—ã–≤–æ–¥–∏—Ç—Å—è –≤ —Ç–∞–±–ª–∏—Ü—É
                result["–ú–µ—Ç–∞–Ω–æ–ª, –∫–≥/—Å—É—Ç"] = methanol_mass_kg
                result["–ú–µ—Ç–∞–Ω–æ–ª, –ª/—Å—É—Ç"] = methanol_vol_liters
                result["–û–ø—Ç–∏–º–∞–ª—å–Ω—ã–π —Ä–∞—Å—Ö–æ–¥ –º–µ—Ç–∞–Ω–æ–ª–∞ (–ª/—Å—É—Ç)"] = optimal_methanol
                result["–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è —ç–∫–æ–Ω–æ–º–∏—è (–ª/—Å—É—Ç)"] = economy

                st.success(
                    "üíß –¢—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–¥–∞—á–∞ –º–µ—Ç–∞–Ω–æ–ª–∞")  # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Å–ª–æ–≤–∞—Ä—å result –≤ —Ç–∞–±–ª–∏—Ü—É –∏ –≤—ã–≤–æ–¥–∏–º –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ.
            else:
                st.success("–í–ª–∞–≥–∞ –≤ –Ω–æ—Ä–º–µ ‚Äî –ø–æ–¥–∞—á–∞ –º–µ—Ç–∞–Ω–æ–ª–∞ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è")
        else:
            st.warning("–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –¥–æ–ø—É—Å—Ç–∏–º–æ–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –≤–ª–∞–≥–∏.")

        st.subheader("üìã –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ä–∞—Å—á–µ—Ç–∞")  # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Å–ª–æ–≤–∞—Ä—å result –≤ —Ç–∞–±–ª–∏—Ü—É –∏ –≤—ã–≤–æ–¥–∏–º –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ.
        result_df = pd.DataFrame([result])
        st.dataframe(result_df, use_container_width=True)

        st.subheader(
            "üìä –ì—Ä–∞—Ñ–∏–∫ —Ä–∞—Å—Ö–æ–¥–∞ –º–µ—Ç–∞–Ω–æ–ª–∞")  # –ï—Å–ª–∏ –º–µ—Ç–∞–Ω–æ–ª —Ä–∞—Å—Å—á–∏—Ç–∞–Ω: –°—Ç—Ä–æ–∏—Ç—Å—è —Å—Ç–æ–ª–±—á–∞—Ç–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞. –°—Ä–∞–≤–Ω–∏–≤–∞—é—Ç—Å—è: —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á—ë—Ç –∏ –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π (—ç–∫–æ–Ω–æ–º–∏—á–Ω—ã–π) —Ä–∞—Å—Ö–æ–¥.
        if "–ú–µ—Ç–∞–Ω–æ–ª, –ª/—Å—É—Ç" in result:
            fig, ax = plt.subplots(figsize=(12, 6))
            ax.bar(["–§–∞–∫—Ç–∏—á–µ—Å–∫–∏–π"], [result["–ú–µ—Ç–∞–Ω–æ–ª, –ª/—Å—É—Ç"]], color='blue', label='–§–∞–∫—Ç–∏—á–µ—Å–∫–∏–π')
            ax.bar(["–û–ø—Ç–∏–º–∞–ª—å–Ω—ã–π"], [result["–û–ø—Ç–∏–º–∞–ª—å–Ω—ã–π —Ä–∞—Å—Ö–æ–¥ –º–µ—Ç–∞–Ω–æ–ª–∞ (–ª/—Å—É—Ç)"]], color='green', label='–û–ø—Ç–∏–º–∞–ª—å–Ω—ã–π')
            ax.set_ylabel("–ú–µ—Ç–∞–Ω–æ–ª, –ª/—Å—É—Ç")
            ax.set_title("–°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ä–∞—Å—Ö–æ–¥–∞ –º–µ—Ç–∞–Ω–æ–ª–∞")
            ax.legend()
            st.pyplot(fig, use_container_width=True)

        # --- –≠–∫—Å–ø–æ—Ä—Ç –≤ Excel ---
        display_columns = [
            "–î–∞—Ç–∞ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞", "–ù–æ–º–µ—Ä –ø—Ä–æ—Ç–æ–∫–æ–ª–∞", "–ú–µ—Ç–∞–Ω", "–≠—Ç–∞–Ω", "–ü—Ä–æ–ø–∞–Ω", "–∏-–ë—É—Ç–∞–Ω", "–Ω-–ë—É—Ç–∞–Ω",
            "–∏-–ü–µ–Ω—Ç–∞–Ω", "–Ω-–ü–µ–Ω—Ç–∞–Ω", "–ì–µ–∫—Å–∞–Ω—ã", "–ì–µ–ø—Ç–∞–Ω—ã", "–û–∫—Ç–∞–Ω—ã", "–ö–∏—Å–ª–æ—Ä–æ–¥", "–í–æ–¥–æ—Ä–æ–¥", "–ì–µ–ª–∏–π", "–ê–∑–æ—Ç"
        ]
        output = BytesIO()  # BytesIO() —Å–æ–∑–¥–∞—ë—Ç –±—É—Ñ–µ—Ä –≤ –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–æ–π –ø–∞–º—è—Ç–∏ ‚Äî –ø–æ —Å—É—Ç–∏, "–≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π —Ñ–∞–π–ª", –∫–æ—Ç–æ—Ä—ã–π –Ω–µ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –Ω–∞ –¥–∏—Å–∫. –û–Ω –Ω—É–∂–µ–Ω –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è Excel-—Ñ–∞–π–ª–∞ –ø–µ—Ä–µ–¥ —Ç–µ–º, –∫–∞–∫ –ø–µ—Ä–µ–¥–∞—Ç—å –µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É —Å–∫–∞—á–∏–≤–∞–Ω–∏—è.
        with pd.ExcelWriter(output, engine='xlsxwriter') as writer:  # –°–æ–∑–¥–∞–Ω–∏–µ Excel-—Ñ–∞–π–ª–∞ —Å –¥–≤—É–º—è –ª–∏—Å—Ç–∞–º–∏
            result_df.to_excel(writer, index=False, sheet_name='–†–∞—Å—á–µ—Ç')
            selected_df[display_columns].to_excel(writer, index=False, sheet_name='–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã')
        st.download_button(
            label="–°–∫–∞—á–∞—Ç—å –æ—Ç—á–µ—Ç –≤ Excel",
            data=output.getvalue(),
            file_name=f"–æ—Ç—á–µ—Ç_–º–µ—Ç–∞–Ω–æ–ª_{field}_{dns}_{stage}.xlsx",
            mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
        )  # –ö–Ω–æ–ø–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è Excel-—Ñ–∞–π–ª–∞. mime=... ‚Äî MIME-—Ç–∏–ø –¥–ª—è Excel-—Ñ–∞–π–ª–æ–≤ (–Ω—É–∂–Ω–æ, —á—Ç–æ–±—ã –±—Ä–∞—É–∑–µ—Ä –ø–æ–Ω—è–ª —Ç–∏–ø —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ).

        # --- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ ---
        st.subheader("üìë –ò—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ")
        st.dataframe(selected_df[display_columns], use_container_width=True)  # –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã –≤ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ.

if __name__ == "__main__":
    run_methanol_calc()