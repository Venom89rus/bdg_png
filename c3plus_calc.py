# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
import streamlit as st  # –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å Streamlit
import matplotlib.pyplot as plt  # –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–æ–≤
import pandas as pd  # –†–∞–±–æ—Ç–∞ —Å —Ç–∞–±–ª–∏—á–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏

# –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∞–Ω–∞–ª–∏–∑–∞ –°‚ÇÉ+–≤
def run():
    # –ü–æ–ª—É—á–∞–µ–º –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–π –¥–∞—Ç–∞—Ñ—Ä–µ–π–º –∏–∑ —Å–µ—Å—Å–∏–æ–Ω–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è (–∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–π –≤ –æ—Å–Ω–æ–≤–Ω–æ–º —Ñ–∞–π–ª–µ)
    df = st.session_state.get("filtered_df", None)

    # –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç –∏–ª–∏ –¥–∞—Ç–∞—Ñ—Ä–µ–π–º –ø—É—Å—Ç–æ–π, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –∏ –ø—Ä–µ–∫—Ä–∞—â–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
    if df is None or df.empty:
        st.warning("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞.")
        return

    # –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Ä–∞–∑–¥–µ–ª–∞
    st.subheader("–ê–Ω–∞–ª–∏–∑ –°‚ÇÉ+–≤.")
    # –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ –∑–∞–ø–∏—Å–µ–π, –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
    st.info(f"üî¢ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞: {len(df)}")

    # –ó–∞–¥–∞–µ–º —Å–ø–∏—Å–æ–∫ —É–≥–ª–µ–≤–æ–¥–æ—Ä–æ–¥–Ω—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤, –≤—Ö–æ–¥—è—â–∏—Ö –≤ –°‚ÇÉ+–≤.
    components = ["–ü—Ä–æ–ø–∞–Ω", "–∏-–ë—É—Ç–∞–Ω", "–Ω-–ë—É—Ç–∞–Ω", "–∏-–ü–µ–Ω—Ç–∞–Ω", "–Ω-–ü–µ–Ω—Ç–∞–Ω", "–ì–µ–∫—Å–∞–Ω—ã", "–ì–µ–ø—Ç–∞–Ω—ã", "–û–∫—Ç–∞–Ω—ã"]

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –≤—Å–µ—Ö –Ω—É–∂–Ω—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –≤ —Ç–∞–±–ª–∏—Ü–µ
    for comp in components:
        if comp not in df.columns:
            st.warning(f"–ö–æ–º–ø–æ–Ω–µ–Ω—Ç {comp} –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –¥–∞–Ω–Ω—ã—Ö.")
            return  # –µ—Å–ª–∏ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ–≥–æ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç ‚Äî –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∞–Ω–∞–ª–∏–∑

    # –ú–æ–ª—è—Ä–Ω—ã–µ –º–∞—Å—Å—ã (–≤ –≥/–º–æ–ª—å) –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
    molar_masses = {
        "–ü—Ä–æ–ø–∞–Ω": 44.1,
        "–∏-–ë—É—Ç–∞–Ω": 58.12,
        "–Ω-–ë—É—Ç–∞–Ω": 58.12,
        "–∏-–ü–µ–Ω—Ç–∞–Ω": 72.15,
        "–Ω-–ü–µ–Ω—Ç–∞–Ω": 72.15,
        "–ì–µ–∫—Å–∞–Ω—ã": 86.18,
        "–ì–µ–ø—Ç–∞–Ω—ã": 100.2,
        "–û–∫—Ç–∞–Ω—ã": 114.23
    }

    Vm = 0.022414  # –ú–æ–ª—è—Ä–Ω—ã–π –æ–±—ä–µ–º (–º¬≥/–º–æ–ª—å) –ø—Ä–∏ –Ω–æ—Ä–º–∞–ª—å–Ω—ã—Ö —É—Å–ª–æ–≤–∏—è—Ö

    # –†–∞—Å—á–µ—Ç —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—è –∫–∞–∂–¥–æ–≥–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ –≤ –≥/–º¬≥:
    for comp in components:
        # –ø–µ—Ä–µ–≤–æ–¥ –∏–∑ % –æ–±. –≤ –≥/–º¬≥: (–æ–±.% / 100) * –º–æ–ª—è—Ä–Ω–∞—è –º–∞—Å—Å–∞ / –º–æ–ª—è—Ä–Ω—ã–π –æ–±—ä–µ–º
        df[comp + "_g_m3"] = df[comp] / 100 * molar_masses[comp] / Vm

    # –°—É–º–º–∏—Ä—É–µ–º –≤—Å–µ –ø–µ—Ä–µ—Å—á–∏—Ç–∞–Ω–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã, –ø–æ–ª—É—á–∞–µ–º –æ–±—â–µ–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –°‚ÇÉ+–≤.
    df["–°3+–≤."] = df[[f"{c}_g_m3" for c in components]].sum(axis=1)

    # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –ë–ª–æ–∫ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    st.markdown("### üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –°‚ÇÉ+–≤.")
    col1, col2, col3 = st.columns(3)
    col1.metric("–°—Ä–µ–¥–Ω–µ–µ", f"{df['–°3+–≤.'].mean():.2f} –≥/–º¬≥")
    col2.metric("–ú–∞–∫—Å–∏–º—É–º", f"{df['–°3+–≤.'].max():.2f} –≥/–º¬≥")
    col3.metric("–ú–∏–Ω–∏–º—É–º", f"{df['–°3+–≤.'].min():.2f} –≥/–º¬≥")

    # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –ì—Ä–∞—Ñ–∏–∫ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –°‚ÇÉ+–≤. –ø–æ –¥–∏–∞–ø–∞–∑–æ–Ω–∞–º ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    st.markdown("### üìä –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –¥–∏–∞–ø–∞–∑–æ–Ω–∞–º –°‚ÇÉ+–≤. (–≥/–º¬≥)")

    # –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤ (–±–∏–Ω–æ–≤) –¥–ª—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö
    bins = [0, 100, 200, 300, 400, 500, 600, 800, 1000, 1300, 1500]
    # –ü–æ–¥–ø–∏—Å–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞
    labels = [f"{bins[i]}‚Äì{bins[i+1]}" for i in range(len(bins) - 1)]

    # –ö–∞—Ç–µ–≥–æ—Ä–∏–∑–∞—Ü–∏—è –∑–Ω–∞—á–µ–Ω–∏–π –ø–æ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞–º
    df["–°3+–≤._range"] = pd.cut(df["–°3+–≤."], bins=bins, labels=labels, include_lowest=True)

    # –ü–æ–¥—Å—á–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∑–∞–ø–∏—Å–µ–π –≤ –∫–∞–∂–¥–æ–º –¥–∏–∞–ø–∞–∑–æ–Ω–µ
    s3plus_counts = df["–°3+–≤._range"].value_counts().sort_index()
    s3plus_counts = s3plus_counts[s3plus_counts > 0]  # –£–±–∏—Ä–∞–µ–º –¥–∏–∞–ø–∞–∑–æ–Ω—ã —Å 0 –∑–Ω–∞—á–µ–Ω–∏—è–º–∏

    # –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–π –≥–∏—Å—Ç–æ–≥—Ä–∞–º–º—ã
    fig, ax = plt.subplots(figsize=(10, 5))
    ax.barh(s3plus_counts.index.astype(str), s3plus_counts.values, color='orange')
    ax.set_xlabel("–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–±–æ—Ä–æ–≤")
    ax.set_ylabel("–î–∏–∞–ø–∞–∑–æ–Ω –°‚ÇÉ+–≤., –≥/–º¬≥")
    ax.set_title("–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –°‚ÇÉ+–≤. –ø–æ –¥–∏–∞–ø–∞–∑–æ–Ω–∞–º")

    # –ü–æ–¥–ø–∏—Å–∏ –Ω–∞ –≥–∏—Å—Ç–æ–≥—Ä–∞–º–º–µ
    for i, v in enumerate(s3plus_counts.values):
        ax.text(v + 0.5, i, str(v), va='center', fontsize=9)

    # –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –≥—Ä–∞—Ñ–∏–∫ –≤ Streamlit
    st.pyplot(fig)

    # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –í—ã–≤–æ–¥ —Ç–∞–±–ª–∏—Ü—ã —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    # –í—ã–±–∏—Ä–∞–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
    display_cols = [col for col in ["–ú–µ—Å—Ç–æ—Ä–æ–∂–¥–µ–Ω–∏–µ", "–î–ù–°", "–°—Ç—É–ø–µ–Ω—å –æ—Ç–±–æ—Ä–∞", "–î–∞—Ç–∞ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞"] if col in df.columns]

    # –°–æ–∑–¥–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –¥–∞—Ç–∞—Ñ—Ä–µ–π–º –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
    df_display = df[display_cols + components + ["–°3+–≤."]].copy()
    df_display["–°3+–≤."] = df_display["–°3+–≤."].round(2)  # –æ–∫—Ä—É–≥–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç

    # CSS-—Å—Ç–∏–ª–∏ –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã (–ª—É—á—à–µ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)
    st.markdown("""
        <style>
            .scroll-free-table table {
                width: 100% !important;
                table-layout: auto !important;
                border-collapse: collapse;
            }
            .scroll-free-table th, .scroll-free-table td {
                text-align: left;
                padding: 6px 10px;
                font-size: 14px;
                border: 1px solid #ddd;
            }
        </style>
    """, unsafe_allow_html=True)

    # –û—Ç–æ–±—Ä–∞–∂–∞–µ–º HTML-—Ç–∞–±–ª–∏—Ü—É –≤ –±–ª–æ–∫–µ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–º–∏ —Å—Ç–∏–ª—è–º–∏
    st.markdown(f'<div class="scroll-free-table">{df_display.to_html(index=False)}</div>', unsafe_allow_html=True)
